<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>WellNexus</title>
    <link rel="stylesheet" href="{{url_for('static', filename='css/style.css') }}">
  </head>
  <body>
    <h1>WellNexus</h1>
  <div class="container">
    <form>
    <div class="input">
     <input type="text" class="form-control" id="input" placeholder="Hello, how are you feeling today?">
      <button type="submit" class = "btn_in">Submit</button>
      </div>
    </form>
    <br>
    <br>
    <h2>Voice Input</h2>
    <p>
    <button id="record-button">Speak</button>
    <button id="stop-record">Stop Recording</button>
    </p>
     <div class="output" id="output">
        {% if output %}
        <p> {{output}}</p>
        {% endif %}
      </div>
    </div>
<!--    <script src="/static/recorder.js"></script> -->

    <script>

    const record = document.getElementById("record-button");
    const stopRecord = document.getElementById("stop-record");
    
    navigator.mediaDevices.getUserMedia({audio:true})
    .then(stream => {handlerFunction(stream)})

    let rec;

    function handlerFunction(stream) {
    rec = new MediaRecorder(stream);
    rec.ondataavailable = e => {
        audioChunks.push(e.data);
        if (rec.state == "inactive") {
        let blob = new Blob(audioChunks, {type: 'audio/mpeg-3'});
//        recordedAudio.src =URL.createObjectURL(blob);
  //      recordedAudio.controls=true;
    //    recordedAudio.autoplay=true;
        sendData(blob)
        }
     }
  }

function sendData(blob) {
  const formA = new FormData();
  formA.append("audio_file", blob);
         //const input = document.querySelector('#input').value;
          fetch('/to_whisper', {
          method: 'POST', 
          body: formA        
          })
          .then(response => response.json())
          .then(data=> {
           const diagnosis = data.response;
           const output = document.querySelector('#output');
           output.innerHTML = `<p>${diagnosis}</p>`;
        });
  }

    stopRecord.disabled = true;
    stopRecord.style.backgroundColor ="brown";
    stopRecord.style.color ="white";

     record.onclick = e => {
     console.log("record button clicked");
     record.disabled = true;
     record.style.backgroundColor = "blue";
     stopRecord.disabled=false;
     audioChunks = [];
     rec.start();
        }    
        stopRecord.onclick = e => {
        console.log("stop button clicked")
        record.disabled =true;
        record.style.backgroundColor ="red";
        rec.stop();
     }
      
      const form = document.querySelector('form');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
         const input = document.querySelector('#input').value;
        fetch('/symptom-checker?input=' +input)
        .then(response => response.json())
        .then(data=> {
          const diagnosis = data.response;
          const output = document.querySelector('#output');
          output.innerHTML = `<p>${diagnosis}</p>`;
        });
      });
    </script>
  </body>
</html>

